<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="movie">

	<select id="sequence" resultType="int">
		select movie_seq.nextval from dual
	</select>

	<select id="findAll" resultType="MovieDto">
		select * from movie order by
		movie_release_date desc
	</select>

	<select id="findByMovieName" resultType="MovieDto">
		select * from movie
		where instr(movie_name, #{movieName}) > 0
		order by movie_release_date
		desc
	</select>

	<!-- 영화 수 출력 쿼리문 -->
	<select id="count" resultType="int">
		select count(*) from movie
	</select>


	
	<insert id="save">
		insert into movie(movie_no, movie_name, movie_director, movie_release_date, 
		movie_time, movie_level, movie_nation, movie_content) 
		values(#{movieNo}, #{movieName}, 
		#{movieDirector}, #{movieReleaseDate}, #{movieTime},
		#{movieLevel}, #{movieNation},
		#{movieContent})
	</insert>

	<delete id="deleteByMovieNo">
		delete from movie where movie_no = #{movieNo}
	</delete>

	<update id="edit">
		update movie
		set
		<if test="dto.movieNo > 0">
			movie_no = #{dto.movieNo},

		</if>
		movie_name = #{dto.movieName},
		movie_release_date =
		#{dto.movieReleaseDate},
		movie_director = #{dto.movieDirector},
		movie_time = #{dto.movieTime},
		movie_level = #{dto.movieLevel},
		movie_nation = #{dto.movieNation},
		movie_content = #{dto.movieContent}
		where movie_no = #{movieNo}
	</update>

	<update id="editUnit">
		update movie
		<set>
			<if test="dto.movieNo > 0">
				movie_no = #{dto.movieNo},
			</if>
			<if test="dto.movieName != null">
				movie_name = #{dto.movieName},
			</if>
			<if test="dto.movieReleaseDate != null">
				movie_release_date = #{dto.movieReleaseDate},
			</if>
			<if test="dto.movieDirector != null">
				movie_director = #{dto.movieDirector},
			</if>
			<if test="dto.movieTime > 0">
				movie_time = #{dto.movieTime},
			</if>
			<if test="dto.movieLevel != null">
				movie_level = #{dto.movieLevel},
			</if>
			<if test="dto.movieNation != null">
				movie_nation = #{dto.movieNation},
			</if>
			<if test="dto.movieContent != null">
				movie_content = #{dto.movieContent},
			</if>
		</set>
		where movie_no = #{movieNo}
	</update>

	<insert id="connectMainImage">
		insert into movie_main_image(movie_no,image_no)
		values(#{movieNo},#{imageNo})
	</insert>

	<!-- 관리자용 영화 목록 조회 -->
	<select id="adminMovieList" resultType="AdminMovieListVO">
		SELECT
		m.movie_no AS movie_no,
		m.movie_name AS movie_name,
		m.movie_director AS movie_director,
		m.movie_nation AS movie_nation,
		LISTAGG(DISTINCT g.genre_name, ', ') WITHIN GROUP (ORDER BY g.genre_name) AS
		genre_name,
		CASE
		WHEN COUNT(a.ACTOR_NAME) > 2 THEN
		SUBSTR(LISTAGG(DISTINCT a.ACTOR_NAME, ', '), 1, INSTR(LISTAGG(DISTINCT a.ACTOR_NAME, ', '),
		',', -1) - 1) || ' 등'
		ELSE
		LISTAGG(DISTINCT a.ACTOR_NAME, ', ') WITHIN GROUP (ORDER BY a.ACTOR_NAME)
		END AS actor_name
		FROM
		movie m
		JOIN movie_genre mg ON m.movie_no = mg.movie_no
		JOIN genre g ON mg.genre_name = g.genre_name
		JOIN actor a ON m.MOVIE_NO = a.MOVIE_NO
		GROUP BY
		m.movie_no,
		m.movie_name,
		m.movie_director,
		m.movie_nation
	</select>
</mapper>
